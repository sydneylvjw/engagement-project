import ae from"https://cdn.jsdelivr.net/npm/maplibre-gl@3.6.2/+esm";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))o(s);new MutationObserver(s=>{for(const a of s)if(a.type==="childList")for(const u of a.addedNodes)u.tagName==="LINK"&&u.rel==="modulepreload"&&o(u)}).observe(document,{childList:!0,subtree:!0});function n(s){const a={};return s.integrity&&(a.integrity=s.integrity),s.referrerPolicy&&(a.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?a.credentials="include":s.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function o(s){if(s.ep)return;s.ep=!0;const a=n(s);fetch(s.href,a)}})();const Le={urgent:"#dc2626",high:"#f97316",medium:"#eab308",low:"#0ea5e9"},V={id:"coalition-dispatch",name:"Coalition Dispatcher",org:"Coalition of Care Dispatch"},we=["Housing Mutual Aid Network","Community Legal Services","Neighborhood Safety Desk","Tenant Health Collective","Mutual Aid Logistics Team"],Te="data/mockReports.json";let E=[];const m={priority:"all",status:"all",responsibility:"all"};let i={...V};const Z={},ie="flicr-engagement-v1",re="flicr-case-state-v1",x=typeof window<"u"&&typeof window.localStorage<"u",b=vt(),N=Lt();let r=null,T=null;const $=document.getElementById("filter-priority"),O=document.getElementById("filter-status"),D=document.getElementById("filter-responsibility"),xe=document.getElementById("filter-reset"),Ae=document.getElementById("recent-list"),Ie=document.getElementById("activity-list"),ce=document.getElementById("case-panel"),Re=document.getElementById("close-case"),F=document.getElementById("case-tags"),_=document.getElementById("case-collaborators-list"),d=document.getElementById("case-actions-body"),Se=document.getElementById("comments-list"),Be=document.getElementById("notes-list"),Ne=document.getElementById("comment-count"),$e=document.getElementById("note-count"),Oe=document.getElementById("comment-form"),v=document.getElementById("comment-text"),k=document.getElementById("reply-hint"),W=document.getElementById("cancel-reply"),le=document.getElementById("note-form"),Y=document.getElementById("note-text"),H=document.getElementById("note-permissions"),De=document.getElementById("comments-column"),ke=document.getElementById("notes-column"),B=document.getElementById("auth-toggle"),q=document.getElementById("user-name"),j=document.getElementById("user-org"),w={status:document.getElementById("case-status"),title:document.getElementById("case-title"),address:document.getElementById("case-address"),type:document.getElementById("case-type-summary"),responsibility:document.getElementById("case-responsibility-summary")},J={status:document.getElementById("case-status-detail"),title:document.getElementById("case-title-detail"),address:document.getElementById("case-address-detail")},g={id:document.getElementById("case-id"),description:document.getElementById("case-description"),filed:document.getElementById("case-filed"),updated:document.getElementById("case-updated"),responsibility:document.getElementById("case-responsibility"),reporter:document.getElementById("case-reporter"),contacted:document.getElementById("case-contacted"),contact:document.getElementById("case-contact")},Me=document.getElementById("reporter-description");let de=!1;const c=new ae.Map({container:"locator-map",style:{version:8,sources:{esri:{type:"raster",tiles:["https://services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}"],tileSize:256}},layers:[{id:"esri",type:"raster",source:"esri"}]},center:[-75.1635,39.9526],zoom:11.2});c.addControl(new ae.NavigationControl({visualizePitch:!0}),"bottom-right");c.on("load",()=>{de=!0,c.addSource("cases",{type:"geojson",data:ye(E)}),c.addLayer({id:"cases-layer",type:"circle",source:"cases",paint:{"circle-radius":7,"circle-color":["get","color"],"circle-stroke-width":1.2,"circle-stroke-color":"#ffffff"}}),c.on("click","cases-layer",e=>{const t=e.features?.[0];if(!t)return;const n=E.find(o=>o.id===t.properties.id);n&&me(n)}),c.on("mouseenter","cases-layer",()=>c.getCanvas().style.cursor="pointer"),c.on("mouseleave","cases-layer",()=>c.getCanvas().style.cursor="")});Re.addEventListener("click",()=>fe());Oe.addEventListener("submit",ct);le.addEventListener("submit",lt);W.addEventListener("click",()=>U());document.addEventListener("keydown",e=>{e.key==="Escape"&&fe()});$.addEventListener("change",()=>Q("priority",$.value));O.addEventListener("change",()=>Q("status",O.value));D.addEventListener("change",()=>Q("responsibility",D.value));xe.addEventListener("click",_e);B.addEventListener("click",St);async function Ue(){ve(),await Pe()}async function Pe(){try{const e=await fetch(Te);if(!e.ok)throw new Error(`Request failed with status ${e.status}`);const n=((await e.json()).reports??[]).map(At);Fe(n)}catch(e){console.error("Unable to load reports dataset",e)}}Ue();function Fe(e){if(E=e,Tt(),xt(e),He(e),A(),r){const t=E.find(n=>n.id===r.id);t&&(r=t,M(t))}}function A(){const e=ue();ee(Ae,ne(e,"reportedAt"),"reportedAt"),ee(Ie,ne(e,"lastEngaged"),"lastEngaged"),he(e)}function ee(e,t,n){if(e.innerHTML="",!t.length){const o=document.createElement("li");o.className="report-empty",o.textContent="No reports match the current filters.",e.appendChild(o);return}t.forEach(o=>{const s=document.createElement("li"),a=document.createElement("button");a.type="button",a.className="report-row",a.innerHTML=qe(o,n),a.addEventListener("click",()=>me(o)),s.appendChild(a),e.appendChild(s)})}function ue(){return E.filter(e=>!(m.priority!=="all"&&e.priority!==m.priority||m.status!=="all"&&e.status!==m.status||m.responsibility!=="all"&&I(e)!==m.responsibility))}function Q(e,t){m[e]=t,A()}function _e(){m.priority="all",m.status="all",m.responsibility="all",$.value="all",O.value="all",D.value="all",A()}function He(e){G($,z(e.map(t=>t.priority))),G(O,z(e.map(t=>t.status))),G(D,z(e.map(t=>I(t))))}function G(e,t){if(!e)return;const n=e.value;e.innerHTML='<option value="all">All</option>',t.forEach(o=>{if(!o)return;const s=document.createElement("option");s.value=o,s.textContent=o,e.appendChild(s)}),n&&Array.from(e.options).some(o=>o.value===n)&&(e.value=n)}function z(e){return[...new Set(e.filter(Boolean))].sort((t,n)=>t.localeCompare(n))}function qe(e,t){const n=`<span class="priority-pill priority-pill--${e.priority}">${e.priority.toUpperCase()} PRIORITY</span>`,o=ut(e.status),s=I(e),a=`<span class="report-label report-label--time">${mt(e[t])}</span>`;return`
    <div class="report-row__header">
      <p class="report-row__title">${e.title}</p>
      <div class="report-row__pills">${n}${o}</div>
    </div>
    <div class="report-row__meta">
      <span>${e.address}</span>
      <span>${s}</span>
    </div>
    <div class="report-row__badges">${a}</div>
  `}function me(e){r=e,M(e),dt(e)}function M(e){je(e),Je(e),Me.textContent=gt(e),g.id.textContent=e.id,g.description.textContent=e.description,g.filed.textContent=K(e.reportedAt),g.updated.textContent=K(e.lastEngaged),g.responsibility.textContent=I(e),g.reporter.textContent=yt(e),g.contacted.textContent=ht(e),g.contact.textContent=Ct(e),Ge(e),ze(e),pe(e),Ye(e),U(),ce.classList.remove("hidden")}function je(e){w.status.textContent=e.status,w.title.textContent=e.title,w.address.textContent=ge(e),w.type.textContent=e.caseType??"Case",w.responsibility.textContent=I(e)}function Je(e){J.status.textContent=e.status,J.title.textContent=e.title,J.address.textContent=ge(e)}function Ge(e){F.innerHTML="";const t=e.tags??[];if(!t.length){F.textContent="No tags yet";return}t.forEach(n=>{const o=document.createElement("span");o.className="case-tag",o.textContent=n,F.appendChild(o)})}function ze(e){_.innerHTML="";const t=e.collaborators??[];if(!t.length){const n=document.createElement("li");n.textContent="No collaborators yet",n.className="collaborator-empty",_.appendChild(n);return}t.forEach(n=>{const o=document.createElement("li");o.textContent=n,_.appendChild(o)})}function pe(e){const t=Ce(e.id),n=L(e);oe(Se,t.comments,"comment",{allowReply:n,report:e}),oe(Be,t.notes,"note"),Ne.textContent=se(t.comments.length,"community update","No community updates yet"),$e.textContent=se(t.notes.length,"internal note","No internal notes yet"),le.classList.toggle("is-hidden",!n),ke.classList.toggle("notes-readonly",!n),H.classList.toggle("is-hidden",n),n?H.textContent="":(H.textContent=i?"Only case owners can capture internal notes.":"Log in to capture internal notes.",Y.value="")}function Ye(e){if(d.innerHTML="",!e){d.innerHTML='<p class="case-action-hint">Select a case to see engagement options.</p>';return}if(!i){d.innerHTML='<p class="case-action-hint">Log in to assign, refer, or tag coalition partners.</p>';return}const t=L(e),n=bt(e),o=!!(e.referredTo&&i&&e.referredTo===i.org);if(t){d.appendChild(Ke(e)),d.appendChild(Ve(e)),d.appendChild(We(e));return}n?(d.appendChild(Qe(e)),d.appendChild(te())):(d.appendChild(te()),d.appendChild(Xe(e)),d.appendChild(Ze(e)),o&&d.appendChild(et(e)))}function y(e,t){const n=document.createElement("div");n.className="action-card";const o=document.createElement("strong");o.textContent=e;const s=document.createElement("p");return s.textContent=t,n.append(o,s),n}function Ke(e){const t=y("Refer to partner","Route this case to a trusted organization."),n=document.createElement("select");n.innerHTML='<option value="">Select partner</option>',we.forEach(s=>{const a=document.createElement("option");a.value=s,a.textContent=s,n.appendChild(a)}),e.referredTo&&(n.value=e.referredTo);const o=document.createElement("button");return o.type="button",o.className="ghost-btn",o.textContent="Refer case",o.addEventListener("click",()=>{n.value&&tt(e,n.value)}),t.append(n,o),t}function Ve(e){const t=y("Mark as closed","Wrap up when the coalition confirms resolution."),n=document.createElement("button");return n.type="button",n.className="ghost-btn",n.textContent="Close case",n.addEventListener("click",()=>nt(e)),t.append(n),t}function We(e){const t=y("Tag collaborators","Notify partners who should track this case."),n=document.createElement("input");n.type="text",n.placeholder="@partner or @user";const o=document.createElement("button");return o.type="button",o.className="ghost-btn",o.textContent="Add tag",o.addEventListener("click",()=>{const s=n.value.trim();s&&(ot(e,s),n.value="")}),t.append(n,o),t}function Qe(e){const t=i?.org??"Coalition of Care Dispatch",n=y("Take responsibility",`Claim this case for ${t}.`),o=document.createElement("button");return o.type="button",o.className="primary-btn",o.textContent="Assign to me",o.addEventListener("click",()=>st(e)),n.append(o),n}function te(){const e=y("Leave a comment","Share observations with the current case owner."),t=document.createElement("button");return t.type="button",t.className="ghost-btn",t.textContent="Jump to comment box",t.addEventListener("click",()=>{v.focus(),De.scrollIntoView({behavior:"smooth",block:"center"})}),e.append(t),e}function Xe(e){const t=y("Request collaboration","Ask the owner to add you to this case."),n=document.createElement("button");return n.type="button",n.className="ghost-btn",n.textContent="Request collaboration",n.addEventListener("click",()=>at(e)),t.append(n),t}function Ze(e){const t=y("Request to assume case","Offer to become the lead for this report."),n=document.createElement("button");return n.type="button",n.className="ghost-btn",n.textContent="Request assignment",n.addEventListener("click",()=>it(e)),t.append(n),t}function et(e){const t=i?.org??"your team",n=y("Accept referral",`This case was referred to ${t}.`),o=document.createElement("button");return o.type="button",o.className="primary-btn",o.textContent="Accept case",o.addEventListener("click",()=>rt(e)),n.append(o),n}function tt(e,t){R(e,{referredTo:t,status:"Referred"}),h(e.id,"notes",`Referred to ${t} with supporting documents.`,f(e))}function nt(e){R(e,{status:"Closed",referredTo:""}),h(e.id,"notes","Marked case as closed for coalition tracking.",f(e))}function ot(e,t){if(e.collaborators=e.collaborators??[],e.collaborators.includes(t))return;const n=[...e.collaborators,t];R(e,{collaborators:n},{touch:!1})}function st(e){i&&(R(e,{responsibility:i.org,referredTo:""}),h(e.id,"notes","Took ownership of this case.",f(e)))}function at(e){h(e.id,"comments","Requested to collaborate on this case.",f(e))}function it(e){h(e.id,"comments","Requested to assume lead responsibility for this case.",f(e))}function rt(e){i&&(R(e,{responsibility:i.org,referredTo:"",status:"In progress"}),h(e.id,"comments","Accepted referred case and moved to in-progress.",f(e)))}function ct(e){if(e.preventDefault(),!r)return;const t=v.value.trim();if(!t)return;const n=T&&T.reportId===r.id?T.entry:null;h(r.id,"comments",t,f(r),{replyTo:n}),v.value="",U()}function lt(e){if(e.preventDefault(),!r||!L(r))return;const t=Y.value.trim();t&&(h(r.id,"notes",t,f(r)),Y.value="")}function fe(){r=null,U(),ce.classList.add("hidden"),c.getLayer("cases-layer")&&c.setPaintProperty("cases-layer","circle-stroke-width",1.2)}function dt(e){c.getSource("cases")&&(c.resize(),c.flyTo({center:e.coordinates,zoom:14,speed:.7}),c.setPaintProperty("cases-layer","circle-stroke-width",["case",["==",["get","id"],e.id],3,1.2]))}function ne(e,t){return[...e].sort((n,o)=>new Date(o[t])-new Date(n[t]))}function ge(e){return`${e.address} · ${e.councilDistrict}`}function I(e){return e.responsibility&&e.responsibility!=="Unassigned"?e.responsibility:"Unassigned"}function ut(e){return e?`<span class="status-pill status-pill--${e.toLowerCase().replace(/\s+/g,"-")}">${e.toUpperCase()}</span>`:""}function K(e){const t=new Date(e);return new Intl.DateTimeFormat("en-US",{weekday:"short",month:"short",day:"numeric",hour:"numeric",minute:"2-digit"}).format(t)}function mt(e){const t=new Intl.RelativeTimeFormat("en",{numeric:"auto"}),o=new Date(e).getTime()-Date.now(),s=Math.round(o/(1e3*60*60));if(Math.abs(s)<24)return t.format(s,"hour");const a=Math.round(s/24);return t.format(a,"day")}function ye(e){return{type:"FeatureCollection",features:e.map(t=>({type:"Feature",properties:{id:t.id,color:Le[t.priority]??"#ea580c"},geometry:{type:"Point",coordinates:t.coordinates}}))}}function he(e=ue()){de&&c.getSource("cases")&&c.getSource("cases").setData(ye(e))}function Ce(e){return b[e]||(b[e]={comments:[],notes:[]}),b[e]}function oe(e,t,n,o={}){if(e.innerHTML="",!t.length){const l=document.createElement("li");l.className="thread-empty",l.textContent=n==="comment"?"No public responses yet. Invite residents to weigh in.":"No coalition notes saved. Capture next steps here.",e.appendChild(l);return}const s=!!o.allowReply,a=o.report??r,u=a?f(a):V.name;t.forEach(l=>{const C=document.createElement("li");if(l.replyTo){const p=document.createElement("div");p.className="reply-preview",p.textContent=`${l.replyTo.author}: ${l.replyTo.text}`,C.appendChild(p)}const S=document.createElement("strong");S.textContent=l.author;const X=document.createElement("p");X.textContent=l.text;const P=document.createElement("span");if(P.className="thread-timestamp",P.textContent=ft(l.createdAt),C.append(S,X,P),n==="comment"&&s&&l.author!==u&&a&&L(a)){const p=document.createElement("button");p.type="button",p.className="ghost-btn ghost-btn--small",p.textContent="Reply",p.addEventListener("click",()=>pt(a,l)),C.appendChild(p)}e.appendChild(C)})}function h(e,t,n,o,s={}){const u=Ce(e)[t],l={id:`${t}-${e}-${Date.now()}`,author:o,text:n,createdAt:new Date().toISOString()};s.replyTo&&(l.replyTo={id:s.replyTo.id,author:s.replyTo.author,text:s.replyTo.text}),u.push(l),u.sort((C,S)=>new Date(C.createdAt)-new Date(S.createdAt)),be(),r&&r.id===e&&pe(r)}function pt(e,t){L(e)&&(T={reportId:e.id,entry:t},k.textContent=`Replying to ${t.author}`,k.classList.remove("is-hidden"),W.classList.remove("is-hidden"),v.placeholder=`Reply to ${t.author}`,v.focus())}function U(){T=null,k.textContent="",k.classList.add("is-hidden"),W.classList.add("is-hidden"),v.placeholder="Leave a comment"}function se(e,t,n="No entries yet"){return e?`${e} ${t}${e!==1?"s":""}`:n}function ft(e){const t=new Date(e),n=Date.now()-t.getTime(),o=Math.max(0,Math.round(n/6e4));if(o<60)return o<=1?"1 minute ago":`${o} minutes ago`;const s=Math.round(o/60);return s<24?s===1?"1 hour ago":`${s} hours ago`:new Intl.DateTimeFormat("en-US",{month:"short",day:"numeric",hour:"numeric",minute:"2-digit"}).format(t)}function gt(e){if(!e.reporter)return"Reporter details unavailable.";const{description:t,submittedAt:n,name:o,type:s}=e.reporter,a=K(n??e.reportedAt),u=[o,s].filter(Boolean).join(" · ");return`${a} — ${t} (${u})`}function yt(e){if(!e.reporter)return"Not provided";const{name:t,role:n,type:o}=e.reporter;return[t,n??o].filter(Boolean).join(" · ")}function ht(e){return e.contactedAnotherAgency?e.contactedAgency||"Another agency notified":"None reported"}function Ct(e){if(!e.optionalContact)return"Not on file";const{name:t,phone:n,email:o}=e.optionalContact;return[t,n,o].filter(Boolean).join(" • ")}function f(e){return i?L(e)?`${i.name} (${i.org})`:i.name:"Guest contributor"}function L(e){return!!i&&e.responsibility===i.org}function bt(e){return!e.responsibility||e.responsibility==="Unassigned"}function R(e,t={},n={}){const o={...t};n.touch!==!1&&(o.lastEngaged=new Date().toISOString()),Object.assign(e,o),Et(e.id,o),A(),he(),r&&r.id===e.id&&M(e)}function Et(e,t){const n=N[e]??{};Object.entries(t).forEach(([o,s])=>{n[o]=Array.isArray(s)?[...s]:s}),N[e]=n,wt()}function vt(){if(!x)return JSON.parse(JSON.stringify(Z));try{const e=localStorage.getItem(ie);if(e)return JSON.parse(e)}catch(e){console.warn("Unable to load engagement state",e)}return JSON.parse(JSON.stringify(Z))}function be(){if(x)try{localStorage.setItem(ie,JSON.stringify(b))}catch(e){console.warn("Unable to save engagement state",e)}}function Lt(){if(!x)return{};try{const e=localStorage.getItem(re);return e?JSON.parse(e):{}}catch(e){return console.warn("Unable to load case state",e),{}}}function wt(){if(x)try{localStorage.setItem(re,JSON.stringify(N))}catch(e){console.warn("Unable to save case state",e)}}function Tt(){E.forEach(e=>{const t=N[e.id];t&&Object.entries(t).forEach(([n,o])=>{e[n]=Array.isArray(o)?[...o]:o})})}function xt(e){x&&(Object.keys(b).length||(e.slice(0,3).forEach((t,n)=>{b[t.id]={comments:[{id:`seed-comment-${t.id}`,author:`${t.neighborhood} neighbor`,text:`Checking in on the ${t.caseFocus?.toLowerCase()??"reported issue"}.`,createdAt:new Date(Date.now()-(n+2)*60*60*1e3).toISOString()}],notes:[{id:`seed-note-${t.id}`,author:"Coalition dispatcher",text:`Coordinating response plan for ${t.caseFocus?.toLowerCase()??"this case"}.`,createdAt:new Date(Date.now()-(n+1)*45*60*1e3).toISOString()}]}}),be()))}function At(e){const t=e.casePriority?.focus??"Community concern",n=e.notes||`Community partners flagged ${t.toLowerCase()} at ${e.location?.address??"this site"}.`;return{id:e.id,title:It(e,t),address:e.location?.address??"Unspecified address",councilDistrict:e.location?.councilDistrict??"District",neighborhood:e.location?.neighborhood??"Philadelphia",caseType:e.caseType??"Case",priority:e.casePriority?.level??"medium",status:Ee(e.status),responsibility:Rt(e),reportedAt:e.createdAt,lastEngaged:e.lastEngaged??e.createdAt,description:n,coordinates:e.location?.coordinates??[-75.1635,39.9526],tags:t?[t]:[],reporter:{name:e.optionalContact?.name??"Community reporter",role:e.optionalContact?"Resident contact":"Hotline submission",type:e.optionalContact?"Community member":"Anonymous",submittedAt:e.createdAt,description:n},contactedAnotherAgency:e.contactedAnotherAgency,contactedAgency:e.contactedAgency,optionalContact:e.optionalContact,referredTo:"",collaborators:[],caseFocus:t}}function It(e,t){const n=e.location?.neighborhood??"community";return`${t?Ee(t):"Community issue"} in ${n}`}function Rt(e){return e.unread?"Unassigned":e.contactedAgency?e.contactedAgency:"Coalition of Care Dispatch"}function Ee(e){return e?e.split(" ").map(t=>t.charAt(0).toUpperCase()+t.slice(1)).join(" "):"Under review"}function St(){i=i?null:{...V},ve(),r?M(r):A()}function ve(){!B||!q||!j||(i?(q.textContent=i.name,j.textContent=i.org,B.textContent="Log out"):(q.textContent="Guest",j.textContent="Log in to collaborate",B.textContent="Log in"))}
